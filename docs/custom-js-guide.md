# ì»¤ìŠ¤í…€ JS ìŠ¤í¬ë¦½íŠ¸ ê°€ì´ë“œ

DM NoteëŠ” ì‚¬ìš©ìê°€ ì‘ì„±í•œ JavaScriptë¥¼ ëŸ°íƒ€ì„ì— ì£¼ì…í•  ìˆ˜ ìˆëŠ” **ì»¤ìŠ¤í…€ JS(Custom JS)** ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì•± ë™ì‘ì„ í™•ì¥í•˜ê³ , ì‹¤ì‹œê°„ í†µê³„ íŒ¨ë„ì´ë‚˜ í‚¤ ì…ë ¥ ì‹œê°í™” ê°™ì€ ê³ ê¸‰ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> âš ï¸ **ë³´ì•ˆ ê²½ê³ **  
> ì»¤ìŠ¤í…€ JSëŠ” ì•± ë‚´ë¶€ APIì™€ DOMì— ì™„ì „í•œ ì ‘ê·¼ ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤. ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”.

---

## ê¸°ë³¸ ì‚¬ìš©ë²•

### 1. ì„¤ì •ì—ì„œ í™œì„±í™”

- ë©”ì¸ ì°½ì—ì„œ **ì„¤ì •(Settings)** íƒ­ì„ ì—½ë‹ˆë‹¤.
- **JS í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”** í† ê¸€ì„ ì¼­ë‹ˆë‹¤.
- ê°™ì€ í–‰ì— í‘œì‹œë˜ëŠ” **í”ŒëŸ¬ê·¸ì¸ ê´€ë¦¬** ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
- ëª¨ë‹¬ í•˜ë‹¨ì˜ **JS í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€** ë²„íŠ¼ì„ ëˆŒëŸ¬ í•˜ë‚˜ ì´ìƒì˜ `.js` íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)
- ëª©ë¡ì—ì„œ ì²´í¬ë°•ìŠ¤ë¡œ í”ŒëŸ¬ê·¸ì¸ë³„ í™œì„±/ë¹„í™œì„± ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³ , íœ´ì§€í†µ ì•„ì´ì½˜ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ í”ŒëŸ¬ê·¸ì¸ì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. ë¹„í™œì„±í™” Â· ì¬ì£¼ì… Â· ë¦¬ë¡œë“œ

- í† ê¸€ì„ ë¹„í™œì„±í™”í•˜ë©´ ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ì´ ì œê±°ë˜ê³  ê° í”ŒëŸ¬ê·¸ì¸ì´ ë“±ë¡í•œ í´ë¦°ì—… í•¨ìˆ˜ê°€ ìˆœì„œëŒ€ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
- í”ŒëŸ¬ê·¸ì¸ ëª©ë¡ì„ ìˆ˜ì •(ì¶”ê°€/ì‚­ì œ/ë¹„í™œì„±í™”)í•˜ë©´ ëª©ë¡ ì „ì²´ê°€ ë‹¤ì‹œ ì£¼ì…ë©ë‹ˆë‹¤.
- ì„¤ì • í™”ë©´ì˜ **ë¦¬ë¡œë“œ** ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì €ì¥ëœ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ì„ ë‹¤ì‹œ ì½ì–´ ë“¤ì…ë‹ˆë‹¤. (ê°œë°œ ì¤‘ íŒŒì¼ì„ ìˆ˜ì •í–ˆì„ ë•Œ í¸ë¦¬í•©ë‹ˆë‹¤)

---

## ì œê³µë˜ëŠ” ì „ì—­ API

DM NoteëŠ” ì»¤ìŠ¤í…€ JS ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì „ì—­ APIì™€ ì»¨ë²¤ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.

### `window.__dmn_custom_js_cleanup`

**ì—­í• **: ìŠ¤í¬ë¦½íŠ¸ê°€ ìƒì„±í•œ ë¦¬ì†ŒìŠ¤(íƒ€ì´ë¨¸, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ, DOM ìš”ì†Œ ë“±)ë¥¼ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.

**ì‚¬ìš© ì‹œì **:

- ì»¤ìŠ¤í…€ JSë¥¼ ë¹„í™œì„±í™”í•  ë•Œ
- ìƒˆ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì£¼ì…í•  ë•Œ(ì¬ì£¼ì…)
- ìœˆë„ìš°ê°€ ì–¸ë§ˆìš´íŠ¸ë  ë•Œ

> â„¹ï¸ ì—¬ëŸ¬ í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•  ê²½ìš° DM NoteëŠ” ê° í”ŒëŸ¬ê·¸ì¸ì„ ìˆœì°¨ì ìœ¼ë¡œ ì£¼ì…í•˜ë©°, ìƒˆë¡œ ì£¼ì…í•˜ê¸° ì „ì— ì§ì „ í”ŒëŸ¬ê·¸ì¸ì˜ í´ë¦°ì—… í•¨ìˆ˜ë¥¼ ë¨¼ì € í˜¸ì¶œí•©ë‹ˆë‹¤.

**ì‚¬ìš©ë²•**:

```javascript
(function () {
  // ë¦¬ì†ŒìŠ¤ ìƒì„± ì˜ˆì‹œ
  const panel = document.createElement("div");
  document.body.appendChild(panel);

  const timer = setInterval(() => {
    console.log("Running...");
  }, 1000);

  const unsubscribe = window.api.keys.onKeyState((data) => {
    console.log("Key event:", data);
  });

  // ì •ë¦¬ í•¨ìˆ˜ ë“±ë¡ (í•„ìˆ˜!)
  window.__dmn_custom_js_cleanup = function () {
    clearInterval(timer);
    unsubscribe();
    panel.remove();
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

**ê¶Œì¥ì‚¬í•­**:

- ëª¨ë“  ì»¤ìŠ¤í…€ JSëŠ” í´ë¦°ì—… í•¨ìˆ˜ë¥¼ ë°˜ë“œì‹œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
- í´ë¦°ì—…ì—ì„œ `delete window.__dmn_custom_js_cleanup`ìœ¼ë¡œ ìê¸° ìì‹ ì„ ì œê±°í•˜ì„¸ìš”.
- ì¬ì£¼ì… ì‹œ ì´ì „ í´ë¦°ì—…ì„ ë¨¼ì € í˜¸ì¶œ: `if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();`

---

### `window.__dmn_window_type`

**ì—­í• **: í˜„ì¬ ë Œë”ëŸ¬ì˜ ìœˆë„ìš° íƒ€ì…ì„ ë¬¸ìì—´ë¡œ ì‹ë³„í•˜ëŠ” ì „ì—­ ë³€ìˆ˜ì…ë‹ˆë‹¤.

**ê°’**:

- `'main'`: ë©”ì¸ ìœˆë„ìš° (ì„¤ì •/í‚¤ ë§µí•‘ UI)
- `'overlay'`: ì˜¤ë²„ë ˆì´ ìœˆë„ìš° (í‚¤ ì‹œê°í™”/ë…¸íŠ¸ ì´í™íŠ¸)
- `undefined`: ìœˆë„ìš°ê°€ ì–¸ë§ˆìš´íŠ¸ëœ ê²½ìš°

**ì‚¬ìš©ë²•**:

```javascript
(function () {
  // ì˜¤ë²„ë ˆì´ ì „ìš© ìŠ¤í¬ë¦½íŠ¸
  if (window.__dmn_window_type !== "overlay") {
    return; // ì˜¤ë²„ë ˆì´ê°€ ì•„ë‹ˆë©´ ì‹¤í–‰ ì•ˆ í•¨
  }

  // ì˜¤ë²„ë ˆì´ì—ì„œë§Œ ë™ì‘í•˜ëŠ” ì½”ë“œ
  const stats = document.createElement("div");
  stats.textContent = "Overlay Active";
  document.body.appendChild(stats);

  window.__dmn_custom_js_cleanup = function () {
    stats.remove();
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

```javascript
(function () {
  // ë©”ì¸ ì „ìš© ìŠ¤í¬ë¦½íŠ¸
  if (window.__dmn_window_type !== "main") {
    return; // ë©”ì¸ ìœˆë„ìš°ê°€ ì•„ë‹ˆë©´ ì‹¤í–‰ ì•ˆ í•¨
  }

  console.log("Main window script initialized");

  window.__dmn_custom_js_cleanup = function () {
    console.log("Main window script cleanup");
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

**ì‚¬ìš© ì¼€ì´ìŠ¤**:

- ì˜¤ë²„ë ˆì´ì—ë§Œ í‘œì‹œë˜ëŠ” ì‹¤ì‹œê°„ í†µê³„ íŒ¨ë„ (`=== 'overlay'`)
- í‚¤ ì…ë ¥ ì‹œê°í™”ì™€ ë…¸íŠ¸ ì´í™íŠ¸ ì—°ë™ (`=== 'overlay'`)
- ë©”ì¸ ì°½ì—ë§Œ ì ìš©ë˜ëŠ” ì„¤ì • UI í™•ì¥ (`=== 'main'`)
- í–¥í›„ ì¶”ê°€ë  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ìœˆë„ìš° íƒ€ì… ëŒ€ì‘ (ì˜ˆ: íŒì—…, ì„œë¸Œìœˆë„ìš°)

---

## ì•± API ì ‘ê·¼ (`window.api`)

ì»¤ìŠ¤í…€ JSëŠ” `window.api`ë¥¼ í†µí•´ ì•±ì˜ ëª¨ë“  ê¸°ëŠ¥ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë¹ ë¥¸ ì‹œì‘

```javascript
// ì•± ì´ˆê¸° ë°ì´í„° ì¡°íšŒ
const bootstrap = await window.api.app.bootstrap();
console.log("Keys:", bootstrap.keys);
console.log("Settings:", bootstrap.settings);

// í˜„ì¬ í‚¤ ë§µí•‘ ì¡°íšŒ
const keyMappings = await window.api.keys.get();
console.log("4key:", keyMappings["4key"]);

// í‚¤ ì…ë ¥ ì´ë²¤íŠ¸ êµ¬ë… (ì˜¤ë²„ë ˆì´ì—ì„œë§Œ ê°€ëŠ¥)
const unsubKeyState = window.api.keys.onKeyState(({ key, state, mode }) => {
  console.log(`[${mode}] ${key} is ${state}`);
});

// í‚¤ ëª¨ë“œ ë³€ê²½ ì´ë²¤íŠ¸ êµ¬ë…
const unsubMode = window.api.keys.onModeChanged(({ mode }) => {
  console.log("Mode changed to:", mode);
});

// ì„¤ì • ì¡°íšŒ
const settings = await window.api.settings.get();
console.log("Background color:", settings.backgroundColor);

// ì„¤ì • ë³€ê²½ êµ¬ë…
const unsubSettings = window.api.settings.onChanged(({ changed, full }) => {
  console.log("Settings changed:", changed);
});

// í´ë¦°ì—… ì‹œ êµ¬ë… í•´ì œ
window.__dmn_custom_js_cleanup = function () {
  unsubKeyState();
  unsubMode();
  unsubSettings();
  delete window.__dmn_custom_js_cleanup;
};
```

### ìƒì„¸ API ë ˆí¼ëŸ°ìŠ¤

`window.api`ì˜ ëª¨ë“  ë©”ì„œë“œ, íƒ€ì…, ì‚¬ìš© íŒ¨í„´ì€ **[`docs/api-reference.md`](../api-reference.md)** ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì£¼ìš” ë„¤ì„ìŠ¤í˜ì´ìŠ¤:

- **`window.api.app`** - ì•± ë¶€íŒ…, ì¬ì‹œì‘, ì™¸ë¶€ URL ì—´ê¸°
- **`window.api.keys`** - í‚¤ ë§¤í•‘, ëª¨ë“œ ë³€ê²½, ì¹´ìš´í„°, ì»¤ìŠ¤í…€ íƒ­
- **`window.api.settings`** - ì„¤ì • ì¡°íšŒ ë° ì—…ë°ì´íŠ¸
- **`window.api.overlay`** - ì˜¤ë²„ë ˆì´ ì œì–´ (í‘œì‹œ/ìˆ¨ê¹€, ì ê¸ˆ, ë¦¬ì‚¬ì´ì¦ˆ)
- **`window.api.css`** / **`window.api.js`** - CSS/JS ì»¤ìŠ¤í…€ ì½”ë“œ ê´€ë¦¬
- **`window.api.presets`** - í”„ë¦¬ì…‹ ì €ì¥/ë¡œë“œ
- **`window.api.bridge`** - ìœˆë„ìš° ê°„ í†µì‹  (í”ŒëŸ¬ê·¸ì¸ ê°„ ë©”ì‹œì§€ ì „ì†¡)
- **`window.api.plugin.storage`** - í”ŒëŸ¬ê·¸ì¸ ë°ì´í„° ì˜ì†í™” (ì„¤ì • ì €ì¥)

ë˜í•œ IPC ì±„ë„ ì €ìˆ˜ì¤€ êµ¬í˜„ì— ëŒ€í•´ì„œëŠ” [`docs/ipc-channels.md`](../ipc-channels.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

---

## í”ŒëŸ¬ê·¸ì¸ ID ì„¤ì •

ê° í”ŒëŸ¬ê·¸ì¸ì€ ê³ ìœ í•œ IDë¥¼ ê°€ì§€ë©°, ì´ IDëŠ” ìŠ¤í† ë¦¬ì§€ ë°ì´í„°ë¥¼ êµ¬ë¶„í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

### `@id` ë©”íƒ€ë°ì´í„°

í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ ìƒë‹¨ì— `@id` ì£¼ì„ì„ ì¶”ê°€í•˜ì—¬ ê³ ìœ  IDë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```javascript
// @id: my-awesome-plugin

(function () {
  // í”ŒëŸ¬ê·¸ì¸ ì½”ë“œ...
})();
```

**ê·œì¹™**:

- IDëŠ” ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ(`-`), ì–¸ë”ìŠ¤ì½”ì–´(`_`)ë§Œ ì‚¬ìš© ê°€ëŠ¥
- kebab-case í˜•ì‹ ê¶Œì¥ (ì˜ˆ: `kps-counter`, `settings-panel`)
- íŒŒì¼ ì²« 20ì¤„ ì´ë‚´ì— ìœ„ì¹˜í•´ì•¼ í•¨

**ë™ì‘**:

- `@id`ê°€ ìˆëŠ” ê²½ìš°: ì§€ì •í•œ IDë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì‚¬ìš©
- `@id`ê°€ ì—†ëŠ” ê²½ìš°: íŒŒì¼ëª…ì„ ìë™ìœ¼ë¡œ ì •ê·œí™”í•˜ì—¬ ì‚¬ìš© (ì˜ˆ: `My Plugin.js` â†’ `my-plugin`)

**ì¤‘ìš”**:

- ê°™ì€ `@id`ë¥¼ ê°€ì§„ í”ŒëŸ¬ê·¸ì¸ì€ ìŠ¤í† ë¦¬ì§€ ë°ì´í„°ë¥¼ ê³µìœ í•©ë‹ˆë‹¤
- í”ŒëŸ¬ê·¸ì¸ì„ ì‚­ì œ í›„ ì¬ì„¤ì¹˜í•´ë„ `@id`ê°€ ê°™ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ê³„ì† ì‚¬ìš©í•©ë‹ˆë‹¤
- IDë¥¼ ë³€ê²½í•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ì—†ê²Œ ë˜ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì„ íƒí•˜ì„¸ìš”

**ì˜ˆì‹œ**:

```javascript
// @id: kps-counter

(function () {
  // ì´ í”ŒëŸ¬ê·¸ì¸ì˜ ëª¨ë“  ìŠ¤í† ë¦¬ì§€ëŠ” 'kps-counter' ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©
  await window.api.plugin.storage.set("maxKps", 150);
})();
```

---

## í”ŒëŸ¬ê·¸ì¸ ìŠ¤í† ë¦¬ì§€ (`window.api.plugin.storage`)

í”ŒëŸ¬ê·¸ì¸ì€ **ìŠ¤í† ë¦¬ì§€ API**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì •ì´ë‚˜ ë°ì´í„°ë¥¼ ì˜ì†ì ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ëŠ” ì•± ì„¤ì • íŒŒì¼ì— í•¨ê»˜ ì €ì¥ë˜ë©°, ì•±ì„ ì¬ì‹œì‘í•´ë„ ìœ ì§€ë©ë‹ˆë‹¤.

### âœ¨ ìë™ ë„¤ì„ìŠ¤í˜ì´ìŠ¤

í”ŒëŸ¬ê·¸ì¸ë³„ë¡œ **ìë™ìœ¼ë¡œ ê²©ë¦¬ëœ ìŠ¤í† ë¦¬ì§€ ê³µê°„**ì´ ì œê³µë©ë‹ˆë‹¤. prefixë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•  í•„ìš”ê°€ ì—†ìœ¼ë©°, ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸ê³¼ì˜ ì¶©ëŒ ê±±ì •ë„ ì—†ìŠµë‹ˆë‹¤.

ê° í”ŒëŸ¬ê·¸ì¸ì´ ì‹¤í–‰ë  ë•Œ `window.api.plugin.storage`ëŠ” ìë™ìœ¼ë¡œ í•´ë‹¹ í”ŒëŸ¬ê·¸ì¸ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë˜í•‘ë˜ì–´, ë‹¤ë¥¸ APIë“¤ê³¼ ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
// âœ… ê°„ë‹¨í•˜ê²Œ í‚¤ë§Œ ì‚¬ìš© (ìë™ìœ¼ë¡œ í”ŒëŸ¬ê·¸ì¸ IDê°€ prefixë¡œ ì¶”ê°€ë¨)
await window.api.plugin.storage.set("settings", { theme: "dark" });
await window.api.plugin.storage.set("position", { x: 100, y: 50 });

// ë°ì´í„° ì¡°íšŒ
const settings = await window.api.plugin.storage.get("settings");
const position = await window.api.plugin.storage.get("position");

// ë°ì´í„° ì‚­ì œ
await window.api.plugin.storage.remove("settings");

// ì´ í”ŒëŸ¬ê·¸ì¸ì˜ ëª¨ë“  ë°ì´í„° ì‚­ì œ
await window.api.plugin.storage.clear();

// ì´ í”ŒëŸ¬ê·¸ì¸ì´ ì €ì¥í•œ í‚¤ ëª©ë¡
const keys = await window.api.plugin.storage.keys();
console.log("ì €ì¥ëœ í‚¤:", keys); // ['settings', 'position']
```

**í”ŒëŸ¬ê·¸ì¸ ì‚­ì œ ì‹œ ìë™ ì •ë¦¬:** í”ŒëŸ¬ê·¸ì¸ì„ ì‚­ì œí•  ë•Œ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ì‚­ì œ ì—¬ë¶€ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìœ¼ë©°, "ë°ì´í„°ì™€ í•¨ê»˜ ì‚­ì œ"ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ í”ŒëŸ¬ê·¸ì¸ì˜ ëª¨ë“  ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì œê±°ë©ë‹ˆë‹¤.

### ê¸°ë³¸ ì‚¬ìš©ë²•

```javascript
(function () {
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();
  if (window.__dmn_window_type !== "overlay") return;

  // ë°ì´í„° ì €ì¥ ë° ì¡°íšŒ
  await window.api.plugin.storage.set("theme", "dark");
  const theme = await window.api.plugin.storage.get("theme");

  // ê°ì²´ ì €ì¥
  await window.api.plugin.storage.set("userPreferences", {
    fontSize: 14,
    showNotifications: true,
  });

  // ì €ì¥ëœ ëª¨ë“  í‚¤ ì¡°íšŒ
  const allKeys = await window.api.plugin.storage.keys();
  console.log(allKeys); // ['theme', 'userPreferences']
})();
```

### ì‹¤ì „ ì˜ˆì œ: ì„¤ì • ì €ì¥ í”ŒëŸ¬ê·¸ì¸

```javascript
(function () {
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();
  if (window.__dmn_window_type !== "overlay") return;

  // ê¸°ë³¸ ì„¤ì •
  const defaultSettings = {
    panelVisible: true,
    position: { x: 10, y: 10 },
    fontSize: 14,
  };

  // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  let settings = null;

  async function loadSettings() {
    settings = await window.api.plugin.storage.get("settings");
    if (!settings) {
      settings = defaultSettings;
      await saveSettings();
    }
    return settings;
  }

  async function saveSettings() {
    await window.api.plugin.storage.set("settings", settings);
  }

  // íŒ¨ë„ ìƒì„±
  const panel = document.createElement("div");
  panel.style.cssText = `
    position: fixed;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
  `;
  document.body.appendChild(panel);

  // ì´ˆê¸°í™”
  loadSettings().then((loaded) => {
    panel.style.left = loaded.position.x + "px";
    panel.style.top = loaded.position.y + "px";
    panel.style.fontSize = loaded.fontSize + "px";
    panel.style.display = loaded.panelVisible ? "block" : "none";
    panel.textContent = "ì„¤ì •ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!";
  });

  // ë“œë˜ê·¸ë¡œ ìœ„ì¹˜ ë³€ê²½ ì‹œ ìë™ ì €ì¥
  let isDragging = false;
  panel.addEventListener("mousedown", () => {
    isDragging = true;
  });
  document.addEventListener("mousemove", async (e) => {
    if (!isDragging) return;
    settings.position = { x: e.clientX, y: e.clientY };
    panel.style.left = e.clientX + "px";
    panel.style.top = e.clientY + "px";
  });
  document.addEventListener("mouseup", async () => {
    if (isDragging) {
      isDragging = false;
      await saveSettings(); // ìœ„ì¹˜ ìë™ ì €ì¥
      console.log("ìœ„ì¹˜ ì €ì¥ë¨:", settings.position);
    }
  });

  window.__dmn_custom_js_cleanup = function () {
    panel.remove();
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

ë” ìì„¸í•œ ë‚´ìš©ì€ **[`docs/api-reference.md#í”ŒëŸ¬ê·¸ì¸-plugin`](./api-reference.md#í”ŒëŸ¬ê·¸ì¸-plugin)** ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

---

## ìœˆë„ìš° ê°„ í†µì‹  (`window.api.bridge`)

í”ŒëŸ¬ê·¸ì¸ì€ **ë¸Œë¦¿ì§€ API**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì¸ ìœˆë„ìš°ì™€ ì˜¤ë²„ë ˆì´ ìœˆë„ìš° ê°„ì— ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê¸°ë³¸ ì‚¬ìš©ë²•

```javascript
// ë©”ì‹œì§€ ì „ì†¡ (ëª¨ë“  ìœˆë„ìš°ì— ë¸Œë¡œë“œìºìŠ¤íŠ¸)
await window.api.bridge.send("MY_EVENT", { data: "hello" });

// íŠ¹ì • ìœˆë„ìš°ì—ë§Œ ì „ì†¡
await window.api.bridge.sendTo("overlay", "OVERLAY_EVENT", { value: 123 });

// ë©”ì‹œì§€ ìˆ˜ì‹ 
const unsub = window.api.bridge.on("MY_EVENT", (data) => {
  console.log("ë°›ì€ ë°ì´í„°:", data);
});

// 1íšŒë§Œ ìˆ˜ì‹ 
window.api.bridge.once("INIT_COMPLETE", (data) => {
  console.log("ì´ˆê¸°í™” ì™„ë£Œ");
});

// ëª¨ë“  ë©”ì‹œì§€ ìˆ˜ì‹  (ë””ë²„ê¹…ìš©)
window.api.bridge.onAny((type, data) => {
  console.log(`[Bridge] ${type}:`, data);
});
```

### ì‹¤ì „ ì˜ˆì œ: ìœˆë„ìš° ê°„ KPS ê³µìœ 

```javascript
// === ì˜¤ë²„ë ˆì´ í”ŒëŸ¬ê·¸ì¸ (kps-sender.js) ===
(function () {
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();
  if (window.__dmn_window_type !== "overlay") return;

  let currentKPS = 0;

  // KPS ê³„ì‚° ë¡œì§
  setInterval(() => {
    currentKPS = calculateKPS(); // ì‹¤ì œ ê³„ì‚° í•¨ìˆ˜

    // ë©”ì¸ ìœˆë„ìš°ë¡œ ì „ì†¡
    window.api.bridge.sendTo("main", "KPS_UPDATE", {
      kps: currentKPS,
      timestamp: Date.now(),
    });
  }, 100);

  window.__dmn_custom_js_cleanup = function () {
    delete window.__dmn_custom_js_cleanup;
  };
})();

// === ë©”ì¸ í”ŒëŸ¬ê·¸ì¸ (kps-display.js) ===
(function () {
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();
  if (window.__dmn_window_type !== "main") return;

  const display = document.createElement("div");
  display.style.cssText =
    "position: fixed; top: 10px; right: 10px; padding: 10px; background: black; color: white;";
  display.textContent = "KPS: 0";
  document.body.appendChild(display);

  // ì˜¤ë²„ë ˆì´ë¡œë¶€í„° KPS ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
  const unsub = window.api.bridge.on("KPS_UPDATE", ({ kps, timestamp }) => {
    display.textContent = `KPS: ${kps}`;
  });

  window.__dmn_custom_js_cleanup = function () {
    unsub();
    display.remove();
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

### ì–‘ë°©í–¥ í†µì‹  íŒ¨í„´

```javascript
// === ë©”ì¸ ìœˆë„ìš°: ë°ì´í„° ìš”ì²­ ===
window.api.bridge.send("REQUEST_STATS", {});

// === ì˜¤ë²„ë ˆì´: ìš”ì²­ ì²˜ë¦¬ ë° ì‘ë‹µ ===
window.api.bridge.on("REQUEST_STATS", () => {
  window.api.bridge.sendTo("main", "RESPONSE_STATS", {
    kps: currentKPS,
    totalKeys: totalKeyCount,
    uptime: Date.now() - startTime,
  });
});

// === ë©”ì¸: ì‘ë‹µ ìˆ˜ì‹  ===
window.api.bridge.once("RESPONSE_STATS", (stats) => {
  console.log("í†µê³„:", stats);
});
```

ë” ìì„¸í•œ ë‚´ìš©ì€ **[`docs/api-reference.md#ë¸Œë¦¿ì§€-bridge`](./api-reference.md#ë¸Œë¦¿ì§€-bridge)** ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

---

## ì˜ˆì œ 1: CPS(Characters Per Second) íŒ¨ë„

ì˜¤ë²„ë ˆì´ì— ì´ˆë‹¹ í‚¤ ì…ë ¥ íšŸìˆ˜ë¥¼ í‘œì‹œí•˜ëŠ” íŒ¨ë„ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```javascript
(function () {
  // ì¬ì£¼ì… ëŒ€ë¹„ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();

  // ì˜¤ë²„ë ˆì´ ì „ìš©
  if (window.__dmn_window_type !== "overlay") return;

  // ì„¤ì •
  const WINDOW_MS = 1000; // 1ì´ˆ ìœˆë„ìš°
  const REFRESH_MS = 100; // 100msë§ˆë‹¤ ê°±ì‹ 

  // ìƒíƒœ
  let currentMode = null;
  let keyMap = {};
  let trackedKeys = new Set();
  const buckets = new Map(); // key => timestamp[]

  // UI ìƒì„±
  const style = document.createElement("style");
  style.textContent = `
    .cps-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      z-index: 999999;
    }
  `;
  document.head.appendChild(style);

  const panel = document.createElement("div");
  panel.className = "cps-panel";
  panel.innerHTML = '<div>Total CPS: <span id="cps-value">0</span></div>';
  document.body.appendChild(panel);
  const valueEl = panel.querySelector("#cps-value");

  // ë¡œì§
  function pruneOld(now) {
    const cutoff = now - WINDOW_MS;
    for (const [key, arr] of buckets.entries()) {
      buckets.set(
        key,
        arr.filter((ts) => ts >= cutoff)
      );
    }
  }

  function render() {
    const now = Date.now();
    pruneOld(now);
    let total = 0;
    for (const key of trackedKeys) {
      total += (buckets.get(key) || []).length;
    }
    valueEl.textContent = total;
  }

  const timer = setInterval(render, REFRESH_MS);

  // ì´ë²¤íŠ¸ êµ¬ë…
  const unsubs = [];

  unsubs.push(
    window.api.keys.onKeyState(({ key, state }) => {
      if (!trackedKeys.has(key) || state !== "DOWN") return;
      if (!buckets.has(key)) buckets.set(key, []);
      buckets.get(key).push(Date.now());
    })
  );

  unsubs.push(
    window.api.keys.onModeChanged(({ mode }) => {
      currentMode = mode;
      trackedKeys = new Set(keyMap[mode] || []);
    })
  );

  // ì´ˆê¸°í™”
  (async () => {
    const boot = await window.api.app.bootstrap();
    keyMap = boot.keys || {};
    currentMode = boot.selectedKeyType || Object.keys(keyMap)[0];
    trackedKeys = new Set(keyMap[currentMode] || []);
  })();

  // ì •ë¦¬
  window.__dmn_custom_js_cleanup = function () {
    clearInterval(timer);
    unsubs.forEach((fn) => fn && fn());
    panel.remove();
    style.remove();
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

---

## ì˜ˆì œ 2: í‚¤ ì…ë ¥ íˆíŠ¸ë§µ

ìµœê·¼ ì…ë ¥ëœ í‚¤ë¥¼ ì‹œê°ì ìœ¼ë¡œ ê°•ì¡° í‘œì‹œí•©ë‹ˆë‹¤.

```javascript
(function () {
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();
  if (window.__dmn_window_type !== "overlay") return;

  const style = document.createElement("style");
  style.textContent = `
    .key-heatmap {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      z-index: 999999;
    }
    .key-heatmap .key-item {
      display: inline-block;
      margin: 2px;
      padding: 4px 8px;
      background: rgba(100, 200, 255, 0.3);
      border-radius: 4px;
      animation: fadeOut 2s forwards;
    }
    @keyframes fadeOut {
      to { opacity: 0; }
    }
  `;
  document.head.appendChild(style);

  const container = document.createElement("div");
  container.className = "key-heatmap";
  document.body.appendChild(container);

  const unsub = window.api.keys.onKeyState(({ key, state }) => {
    if (state !== "DOWN") return;

    const keyEl = document.createElement("span");
    keyEl.className = "key-item";
    keyEl.textContent = key;
    container.appendChild(keyEl);

    setTimeout(() => keyEl.remove(), 2000);
  });

  window.__dmn_custom_js_cleanup = function () {
    unsub();
    container.remove();
    style.remove();
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

---

## ì˜ˆì œ 3: ë©”ì¸ ì „ìš© - ì„¤ì • ë³€ê²½ ë¡œê·¸

ë©”ì¸ ìœˆë„ìš° ì½˜ì†”ì— ì„¤ì • ë³€ê²½ ì´ë ¥ì„ ê¸°ë¡í•©ë‹ˆë‹¤.

```javascript
(function () {
  if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();

  // ë©”ì¸ ì „ìš©
  if (window.__dmn_window_type !== "main") return;

  console.log("[Settings Logger] Started");

  const unsub = window.api.settings.onChanged((settings) => {
    console.log("[Settings Changed]", new Date().toISOString(), settings);
  });

  window.__dmn_custom_js_cleanup = function () {
    unsub();
    console.log("[Settings Logger] Stopped");
    delete window.__dmn_custom_js_cleanup;
  };
})();
```

---

## ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ê°ì‹¸ê¸°

ìŠ¤ì½”í”„ ì˜¤ì—¼ì„ ë°©ì§€í•˜ê³  ì¬ì£¼ì… ì‹œ ì¶©ëŒì„ ë§‰ìŠµë‹ˆë‹¤.

```javascript
(function () {
  // ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ
})();
```

### 2. ì¬ì£¼ì… ëŒ€ë¹„ í´ë¦°ì—… ë¨¼ì € í˜¸ì¶œ

```javascript
if (window.__dmn_custom_js_cleanup) window.__dmn_custom_js_cleanup();
```

### 3. ìœˆë„ìš° íƒ€ì… ì²´í¬

```javascript
// ì˜¤ë²„ë ˆì´ ì „ìš©
if (window.__dmn_window_type !== "overlay") return;

// ë©”ì¸ ì „ìš©
if (window.__dmn_window_type !== "main") return;

// íŠ¹ì • ìœˆë„ìš° íƒ€ì…ì—ì„œë§Œ ì‹¤í–‰
const allowedTypes = ["overlay", "main"];
if (!allowedTypes.includes(window.__dmn_window_type)) return;
```

### 4. í´ë¦°ì—… í•¨ìˆ˜ í•„ìˆ˜ êµ¬í˜„

```javascript
window.__dmn_custom_js_cleanup = function () {
  // íƒ€ì´ë¨¸ ì •ë¦¬
  clearInterval(timerId);
  clearTimeout(timeoutId);

  // ì´ë²¤íŠ¸ êµ¬ë… í•´ì œ
  unsubscribers.forEach((fn) => fn && fn());

  // DOM ì •ë¦¬
  elements.forEach((el) => el.remove());

  // ìê¸° ìì‹  ì œê±°
  delete window.__dmn_custom_js_cleanup;
};
```

### 5. ì—ëŸ¬ í•¸ë“¤ë§

```javascript
try {
  const data = await window.api.app.bootstrap();
  // ...
} catch (error) {
  console.error("[Custom JS] Error:", error);
}
```

### 6. ì„±ëŠ¥ ê³ ë ¤

- `requestAnimationFrame`ìœ¼ë¡œ ë Œë”ë§ ìµœì í™”
- ê³¼ë„í•œ DOM ì¡°ì‘ ì§€ì–‘
- ì´ë²¤íŠ¸ ì“°ë¡œí‹€ë§/ë””ë°”ìš´ì‹± ì ìš©

---

## ë””ë²„ê¹… íŒ

### 1. ì½˜ì†” í™•ì¸

- **ë©”ì¸ ìœˆë„ìš°**: `Ctrl+Shift+I` (ê°œë°œì ë„êµ¬)
- **ì˜¤ë²„ë ˆì´ ìœˆë„ìš°**: ë°±ì—”ë“œ ë¡œê·¸ ë˜ëŠ” ë³„ë„ ë””ë²„ê¹… ì„¤ì • í•„ìš”

### 2. í´ë¦°ì—… í™•ì¸

```javascript
window.__dmn_custom_js_cleanup = function () {
  console.log("[Cleanup] Running cleanup...");
  // ì‹¤ì œ ì •ë¦¬ ì½”ë“œ
  console.log("[Cleanup] Done");
  delete window.__dmn_custom_js_cleanup;
};
```

### 3. ì¬ì£¼ì… í…ŒìŠ¤íŠ¸

í† ê¸€ì„ ì—¬ëŸ¬ ë²ˆ ê»ë‹¤ ì¼œë©´ì„œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë‚˜ ì¤‘ë³µ ì‹¤í–‰ì´ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

---

## ì£¼ì˜ì‚¬í•­

### ë³´ì•ˆ

- **ì ˆëŒ€ ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”.**
- ìŠ¤í¬ë¦½íŠ¸ëŠ” ì•± ë‚´ë¶€ API, íŒŒì¼ ì‹œìŠ¤í…œ, ë„¤íŠ¸ì›Œí¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- í”„ë¦¬ì…‹ ê³µìœ  ì‹œ ì»¤ìŠ¤í…€ JSëŠ” ë³„ë„ë¡œ ê²€í†  í›„ ì‚¬ìš©í•˜ì„¸ìš”.

### í˜¸í™˜ì„±

- Tauri 2 WebView ê¸°ë°˜ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤(Chromium ì—”ì§„).
- ES6+ ë¬¸ë²• ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
- Node.js APIëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤(`window.api`ë§Œ ì‚¬ìš©).

### ìœ ì§€ë³´ìˆ˜

- DM Note ì—…ë°ì´íŠ¸ ì‹œ `window.api` ì‹œê·¸ë‹ˆì²˜ê°€ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì£¼ìš” ë³€ê²½ì‚¬í•­ì€ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ì™€ [`docs/ipc-channels.md`](./ipc-channels.md)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

---

## ì¶”ê°€ ë¦¬ì†ŒìŠ¤

- **Frontend API ë ˆí¼ëŸ°ìŠ¤**: [`docs/api-reference.md`](../api-reference.md) - `window.api` ì™„ì „ ë ˆí¼ëŸ°ìŠ¤
- **IPC ì±„ë„ ë ˆí¼ëŸ°ìŠ¤**: [`docs/ipc-channels.md`](../ipc-channels.md) - ë°±ì—”ë“œ êµ¬í˜„ ìƒì„¸
- **í‚¤ ë§µí•‘ êµ¬ì¡°**: `src/types/keys.ts`
- **ì„¤ì • ìŠ¤í‚¤ë§ˆ**: `src/types/settings.ts`
- **í”„ë¦¬ì…‹ ê°€ì´ë“œ**: `docs/readme_en.md` (Preset ì„¹ì…˜)

---

ì»¤ìŠ¤í…€ JSë¡œ DM Noteë¥¼ ììœ ë¡­ê²Œ í™•ì¥í•˜ì„¸ìš”! ğŸ¹âœ¨
